<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

</body>
<script type="text/javascript">
    // 没有内部状态，不需要再关心上传的类型
    var Upload = function () {};

    Upload.prototype.delFile = function (id) {
        // 在删除之前需要知道文件的大小
        // 所以使用 管理器 来将文件大小附着到实例上 方便接下来的判断
        uploadManager.setExternalState(id, this); 
        if (this.fileSize < 3000) {
            return this.dom.parentNode.removeChild(this.dom);
        }

        if (window.confirm('确定要删除该文件吗? ' + this.fileName)) {
            return this.dom.parentNode.removeChild(this.dom);
        }
    }


    // 创建的工厂模式彻底变成了一个单例
    var UploadFactory = (function () {
        var createdFlyWeightObjs;
        return {
            create: function (uploadType) {
                if (createdFlyWeightObjs) {
                    return createdFlyWeightObjs;
                }
                return createdFlyWeightObjs = new Upload(uploadType);
            }
        }
    })();


    // 创建一个管理器用于管理外部状态
    var uploadManager = (function () {
        var uploadDatabase = {};
        return {
            // 添加 upload 对象
            add: function (id, uploadType, fileName, fileSize) {
                // 工厂+单例创建一个 upload 对象
                var flyWeightObj = UploadFactory.create(uploadType);
                var dom = document.createElement('div');
                dom.innerHTML =
                    '<span>文件名称:' + fileName + ', 文件大小: ' + fileSize + '</span>' +
                    ', 文件类型: ' + uploadType + '</span>' +
                    '<button class="delFile">删除</button>';
                dom.querySelector('.delFile').onclick = function () {
                    flyWeightObj.delFile(id);
                }

                document.body.appendChild(dom);
                uploadDatabase[id] = {
                    fileName: fileName,
                    fileSize: fileSize,
                    dom: dom
                };
                console.log(`SL: - uploadManager - uploadDatabase`, uploadDatabase)
                return flyWeightObj;
            },
            setExternalState: function (id, flyWeightObj) {
                console.log(`SL: - setExternalState - flyWeightObj`, flyWeightObj)
                var uploadData = uploadDatabase[id];
                console.log(`SL: - setExternalState - uploadData`, uploadData)
                for (var i in uploadData) {
                    flyWeightObj[i] = uploadData[i];
                }
                console.log(`SL: - setExternalState - flyWeightObj`, flyWeightObj)
            }
        }
    })();

    var id = 0;
    window.startUpload = function (uploadType, files) {
        for (var i = 0, file; file = files[i++];) {
            var uploadObj = uploadManager.add(++id, uploadType, file.fileName, file.fileSize);
        }
    };


    startUpload('plugin', [
        {
            fileName: '1.txt',
            fileSize: 1000
        },
        {
            fileName: '2.html',
            fileSize: 3000
        },
        {
            fileName: '3.txt',
            fileSize: 5000
        }
    ]);
    startUpload('flash', [
        {
            fileName: '4.txt',
            fileSize: 1000
        },
        {
            fileName: '5.html',
            fileSize: 3000
        },
        {
            fileName: '6.txt',

            fileSize: 5000
        }
    ]);

</script>

</html>